var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.HeatmapSidebar=(function(a){__extends(b,a);b.prototype.options=null;function b(d,c){this.pluginInit=__bind(this.pluginInit,this);this.reloadAnnotations=__bind(this.reloadAnnotations,this);this.groupAndColor=__bind(this.groupAndColor,this);this.clearGrouping=__bind(this.clearGrouping,this);this.getPos=__bind(this.getPos,this);this.groupingButtonPressed=__bind(this.groupingButtonPressed,this);this.options=c;_ref=b.__super__.constructor.apply(this,arguments);return _ref}b.prototype.unfilteredAnnotations=null;b.prototype.groupedAnnotations=null;b.prototype.groupthreshold=2;b.prototype.useGrouping=1;b.prototype.getPos=function(c){var d=$(c).offset();return{x:d.left,y:d.top-$($(".annotator-wrapper")[0]).offset().top}};b.prototype.pluginInit=function(){console.log("HeatmapSidebar-pluginInit");if(!Annotator.supported()){console.log("Annotator is not supported");return}this.annotator.subscribe("annotationsLoaded",this.reloadAnnotations);this.annotator.subscribe("annotationUploaded",this.reloadAnnotations);this.annotator.subscribe("annotationDeleted",this.reloadAnnotations);this.annotator.subscribe("annotationCreated",this.reloadAnnotations);var e=document.createElement("div");var d="onOffGroupButton";e.setAttribute("class",d);e.innerHTML="Turn Grouping: OFF";$(".annotator-wrapper")[0].appendChild(e);var c=this;$(e).click(function(f){c.groupingButtonPressed()})};b.prototype.clearGrouping=function(){console.log("Clearing Groups");$(".groupButton").remove();$.each(this.unfilteredAnnotations,function(c){if(c.highlights!=undefined){$.each(c.highlights,function(d){$(d).css("background-color","inherit")})}})};b.prototype.groupAndColor=function(){console.log("Grouping Annotations");annotations=this.unfilteredAnnotations;lineAnnDict={};var c=this;annotations.forEach(function(d){if(d.highlights!=undefined){var e=Math.round(c.getPos(d.highlights[0]).y);if(lineAnnDict[e]==undefined){lineAnnDict[e]=[d];return}else{lineAnnDict[e].push(d);return}}});this.groupedAnnotations=null;this.groupedAnnotations=lineAnnDict;var c=this;$.each(lineAnnDict,function(d,e){if(e.length>c.groupthreshold){e.forEach(function(f){$.each(f.highlights,function(h,g){$(g).css("background-color","inherit")})})}else{e.forEach(function(f){$.each(f.highlights,function(h,g){$(g).css("background-color","rgba(255,255,10,.3")})})}})};b.prototype.reloadAnnotations=function(){console.log("Reloading Annotations");var e=this.annotator.plugins.Store.annotations;this.unfilteredAnnotations=e;this.clearGrouping();this.groupAndColor();console.log("Continue Reloading");var d=this;$.each(this.groupedAnnotations,function(f,i){if(i.length>d.groupthreshold){var h=document.createElement("div");var g="groupButton";h.setAttribute("class",g);$(h).css("top",""+f+"px");h.innerHTML=i.length;$(h).attr("data-selected","0");$(".annotator-wrapper")[0].appendChild(h);$(h).click(function(j){if($(j.srcElement).attr("data-selected")=="0"){e.forEach(function(k){$.each(k.highlights,function(l,m){$(m).css("background-color","inherit")})});console.log($(j.srcElement).css("top").replace("px",""));d.groupedAnnotations[$(j.srcElement).css("top").replace("px","")].forEach(function(k){$.each(k.highlights,function(l,m){$(m).css("background-color","rgba(255,255,10,0.3")})});$(j.srcElement).attr("data-selected","1")}else{e.forEach(function(k){$(k).css("background-color","inherit")});d.groupAndColor();$(j.srcElement).attr("data-selected","0")}})}});var d=this;var c=d.unfilteredAnnotations.length;setTimeout(function(){if(c!=d.unfilteredAnnotations.length){d.reloadAnnotations()}},500);return};b.prototype.groupingButtonPressed=function(){if(this.useGrouping==1){this.clearGrouping();this.annotator.unsubscribe("annotationsLoaded",this.reloadAnnotations);this.annotator.unsubscribe("annotationUploaded",this.reloadAnnotations);this.annotator.unsubscribe("annotationDeleted",this.reloadAnnotations);this.annotator.unsubscribe("annotationCreated",this.reloadAnnotations);this.useGrouping=0;$(".onOffGroupButton").html("Turn Grouping: ON");this.annotator.plugins.Store.annotations.forEach(function(c){$.each(c.highlights,function(d,e){$(e).css("background-color","")})})}else{this.reloadAnnotations();this.annotator.subscribe("annotationsLoaded",this.reloadAnnotations);this.annotator.subscribe("annotationUploaded",this.reloadAnnotations);this.annotator.subscribe("annotationDeleted",this.reloadAnnotations);this.annotator.subscribe("annotationCreated",this.reloadAnnotations);this.useGrouping=1;$(".onOffGroupButton").html("Turn Grouping: OFF")}};return b})(Annotator.Plugin);